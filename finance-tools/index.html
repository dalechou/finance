<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stock & Forex CSV Exporter (CORS proxy)</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    button { font-size: 1.2em; padding: 0.5em 1em; }
    .status { margin-top: 1em; color: #555; }
    pre { background: #f4f4f4; padding: 1em; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>Stock & Forex CSV Exporter (CORS proxy)</h1>
  <button id="genBtn">Generate tickers.txt & forex.txt</button>
  <div class="status" id="status"></div>
  <pre id="debug" style="display:none"></pre>
  <script>
    // Helper: fetch and parse Yahoo summary price for a ticker
    async function fetchYahooPrice(ticker) {
      const url = `https://corsproxy.io/?https://finance.yahoo.com/quote/${ticker}`;
      const resp = await fetch(url);
      const html = await resp.text();
      // Parse price from <fin-streamer data-field="regularMarketPrice">
      const match = html.match(/<fin-streamer[^>]*data-field="regularMarketPrice"[^>]*>([\d.,]+)<\/fin-streamer>/);
      if (match) return match[1].replace(/,/g, "");
      throw new Error(`Could not parse price for ${ticker}`);
    }
    async function fetchUsdTwdYahoo() {
      const url = `https://corsproxy.io/?https://finance.yahoo.com/quote/USDTWD=X`;
      const resp = await fetch(url);
      const html = await resp.text();
      const match = html.match(/<fin-streamer[^>]*data-field="regularMarketPrice"[^>]*>([\d.,]+)<\/fin-streamer>/);
      if (match) return match[1].replace(/,/g, "");
      throw new Error("Could not parse USD/TWD rate");
    }
    function downloadFile(filename, content) {
      const blob = new Blob([content], {type: "text/csv"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
      }, 0);
    }
    document.getElementById('genBtn').onclick = async () => {
      const status = document.getElementById('status');
      const debug = document.getElementById('debug');
      status.textContent = "Fetching data from Yahoo Finance (via CORS proxy)...";
      debug.style.display = "none";
      try {
        const tickers = ["MSFT", "AAPL", "NVDA", "TSM"];
        const prices = [];
        for (const ticker of tickers) {
          status.textContent = `Fetching ${ticker}...`;
          const price = await fetchYahooPrice(ticker);
          prices.push([ticker, price]);
        }
        status.textContent = "Fetching USD/TWD forex rate...";
        const fx = await fetchUsdTwdYahoo();

        // Write tickers.txt
        let tickersCSV = "symbol,price\n";
        for (const [t, p] of prices) tickersCSV += `${t},${p}\n`;
        downloadFile("tickers.txt", tickersCSV);

        // Write forex.txt
        let forexCSV = "pair,rate\nUSD/TWD," + fx + "\n";
        downloadFile("forex.txt", forexCSV);

        status.textContent = "Done! Files downloaded.";
      } catch (e) {
        status.textContent = "Error: " + e.message;
        debug.textContent = e.stack;
        debug.style.display = "block";
      }
    };
  </script>
</body>
</html>
